---
lab:
    title: 'ラボ: YAML を使用したコードとしてのパイプラインの構築'
    module: 'モジュール 11: Azure Pipelines を使用した継続的デプロイの実装'
---

# ラボ: YAML を使用したコードとしてのパイプラインの構築
# 学生用ラボ マニュアル

## ラボの概要

多くのチームは YAML を使用してビルドを定義し、パイプラインをリリースすることを好みます。これにより、ビジュアル デザイナーを使用した場合と同じパイプラインの機能にアクセスできます。ただし、マークアップ ファイルは他のソース ファイルと同様に管理できます。YAML ビルドの定義は、該当するファイルをリポジトリのルートに加えるだけでプロジェクトに追加できます。Azure DevOps は、人気の高いプロジェクトの種類の既定テンプレートのほか、YAML デザイナーを提供して、ビルドおよびリリース タスクの定義プロセスを簡素化します。

## 目標

このラボを完了すると、次のことができるようになります。

- Azure DevOps で YAML を使用して CI/CD パイプラインをコードとして構成する

## ラボの所要時間

-   推定時間: **60 分**

## 指示

### 開始する前に

#### ラボの仮想マシンにログインする

次の認証情報を使用して、Windows 10 仮想マシンにサインインしていることを確認します。
    
-   ユーザー名: **Student**
-   パスワード: **Pa55w.rd**

#### このラボで必要なアプリケーションのレビュー

このラボで使用するアプリケーションを特定:
    
-   Microsoft Edge

#### Azure DevOps 組織を設定します。 

このラボで使用できる Azure DevOps 組織がまだない場合は、[組織またはプロジェクト コレクションの作成](https://docs.microsoft.com/ja-jp/azure/devops/organizations/accounts/create-organization?view=azure-devops) で利用できる手順に従って作成してください。

#### Azure サブスクリプションの準備

-   既存の Azure サブスクリプションを識別するか、新しいものを作成します。
-   Azure サブスクリプションでは所有者のロール、Azure サブスクリプションに関連のある Azure AD テナントではグローバル管理者のロールで Microsoft アカウントまたは Azure AD アカウントがあることを確認します。詳細については、[Azure portal を使用して Azure ロールの割り当てを一覧表示する](https://docs.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-list-portal) および [Azure Active Directory で管理者ロールを表示して割当てる](https://docs.microsoft.com/ja-jp/azure/active-directory/roles/manage-roles-portal#view-my-roles) を参照してください。

### 演習 0: ラボの前提条件の構成

この演習では、ラボの前提条件を設定します。これは、Azure DevOps Demo Generator テンプレートと Azure リソースに基づいて事前に構成された Parts Unlimited チーム プロジェクトで構成され、Azure Web アプリと Azure SQL データベースが含まれます。 

#### タスク 1: チーム プロジェクトを構成する

このタスクでは、Azure DevOps Demo Generator を使用して、**PartsUnlimited-YAML** テンプレートに基づいて新しいプロジェクトを生成します。

1.  ラボのコンピューターで Web ブラウザーを起動し、[Azure DevOps Demo Generator](https://azuredevopsdemogenerator.azurewebsites.net) に移動します。このユーティリティ サイトは、ラボで必要なコンテンツ (作業項目、リポジトリなど) が事前設定されている新しい Azure DevOps プロジェクトをアカウント内で作成するプロセスを自動化します。 

    > **注**: サイトの詳細については、https://docs.microsoft.com/ja-jp/azure/devops/demo-gen をご覧ください。

1.  「**サインイン**」 をクリックし、Azure DevOps サブスクリプションに関連のある Microsoft アカウントを使用してサインインします。
1.  必要な場合は、「**Azure DevOps Demo Generator**」 ページで 「**承諾する**」 をクリックし、Azure DevOps サブスクリプションへのアクセス許可要求を承諾します。
1.  「**新しいプロジェクトの作成**」 ページで 「**新しいプロジェクト名**」 テキストボックスに「**YAML を使用したパイプラインのコードとしての構成**」と入力します。「**組織の選択**」 ドロップダウン リストで Azure DevOps 組織を選択し、「**テンプレートの選択**」 をクリックします。
1.  テンプレートのリストのツールバーで 「**一般**」 をクリックし、「**PartsUnlimited-YAML**」 テンプレートを選択して 「**テンプレートの選択**」 をクリックします。
1.  再び 「**新しいプロジェクトの作成**」 ページで 「**プロジェクトの作成**」 をクリックします。

    > **注**: プロセスが完了するまでお待ちください。これにはおよそ 2 分かかります。プロセスが失敗した場合は、DevOps 組織に移動し、プロジェクトを削除して、再試行してください。

1.  「**新しいプロジェクトの作成**」 ページで 「**Bavigate to Project**」 をクリックします。

#### タスク 2: Azure リソースを作成する

このタスクでは、Azure portal を使用して Azure Web アプリと Azure SQL データベースを作成します。

1.  ラボのコンピューターで Web ブラウザーを起動し、[**Azure Portal**](https://portal.azure.com) に移動します。このラボで使用する Azure サブスクリプションで所有者のロールがあり、このサブスクリプションに関連のある Azure ADテナントでグローバル管理者のロールがあるユーザー アカウントを使ってサインインします。
1.  Azure portal で、ページの左上にある横線 3 本のアイコンをクリックし、ハブ メニューでは 「**+ リソースの作成**」 をクリックします。
1.  「**新規**」 ブレードの検索テキスト ボックスに「**Web アプリ + SQL**」と入力してから **Enter** キーを押します。
1.  「**Web アプリ + SQL**」 で 「**作成**」 をクリックします。
1.  「**Web アプリ + SQL**」 ブレードで以下の設定を指定します。

    | 設定 | 値 |
    | --- | --- |
    | アプリの名前 | 有効でグローバルに一意の DNS ホスト名 |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループ「**az400m11l01-RG**」の名前 |

1.  「**App Service プラン/場所**」 をクリックし、「**App Service プラン**」 ブレードで 「**+ 新規作成**」 をクリックします。
1.  「**新しい App Service プラン**」 ブレードで以下の設定を指定して 「**OK**」 をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | App Service プラン | 有効な名前 |
    | 場所| このラボで使用するリソースをデプロイしたい Azure リージョンの名前 |
    | 価格レベル | **D1 Shared** |

1.  再び 「**Web アプリ + SQL**」 ブレードで 「**SQL Database**」 をクリックします。
1. **＋新しいデータベースの作成** をクリックします。
1.  「**SQL Database**」 ブレードで 「**名前**」 テキストボックスに「**partsunlimited**」と入力します。
1.  「**SQL データベース**」 ブレードで 「**サーバーを選択**」 をクリックします。
1.  「**新しいサーバー**」 ブレードで以下の設定を指定して 「**選択**」 をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | サーバー名 | 有効でグローバルに一意の DNS ホスト名 |
    | サーバー管理者のログイン | 学生 |
    | パスワード | Pa55w.rd1234 |
    | 場所 | App Service プラン向けに選択した Azure リージョンの名前 |
    | Azure サービスにサーバーへのアクセスを許可する | enabled |

1.  「**SQL Database**」 ブレードで 「**選択**」 をクリックします。
1.  再び 「**Web App + SQL**」 ブレードで 「**作成**」 をクリックします。 

    > **注**: プロセスが完了するまでお待ちください。これにはおよそ 2 分かかります。 

### 演習 1: Azure DevOps で YAML を使用して CI/CD パイプラインをコードとして構成する

この演習では、Azure DevOps で YAML を使用して CI/CD パイプラインをコードとして構成します。

#### タスク 1: 既存のパイプラインを削除する

このタスクでは、既存のパイプラインを削除します。

1.  ラボのコンピューターで、Azure DevOps ポータルに 「**Configuring Pipelines as Code with YAML**」 プロジェクトが表示されているブラウザー ウィンドウに切り替え、垂直のナビゲーション ペインで 「**パイプライン**」 を選択します。

    > **注**: YAML パイプラインを構成する前に、既存のビルド パイプラインを無効にします。

1.  「**パイプライン**」 ペインで 「**PartsUnlimited**」 エントリを選択します。 
1.  「**PartsUnlimited**」 ブレードの右上コーナーで、垂直の省略記号をクリックし、ドロップダウン メニューで 「**削除**」 を選択します。
1.  「**PartsUnlimited**」と書き込んで 「**削除**」 をクリックします。
1.  垂直のナビゲーション ペインで **「リポジトリ」 > 「ファイル」** を選択します。**マスター** ブランチ (「**ファイル**」 ウィンドウの最上部にあるドロップダウン) の **azure-pipelines.yml** ファイルで、垂直の省略記号をクリックします。ドロップダウン メニューで 「**削除**」 を選択します。「**コミット**」 をクリックして、マスター ブランチで変更をコミットします (既定のオプションのままにします)。

#### タスク 2: YAML ビルド定義を追加する

このタスクでは、既存のプロジェクトに YAML ビルドの定義を追加します。

1.  「**パイプライン**」 ハブで 「**パイプライン**」 に戻ります。 
1.  「**最初のパイプラインの作成**」 ウィンドウで 「**パイプラインの作成**」 をクリックします。 

    > **注**: ウィザードを使い、プロジェクトに基づいて YAML の定義を自動的に作成します。

1.  「**Where is your code?**」 ペインで 「**Azure Repos Git (YAML)**」 オプションをクリックします。
1.  「**リポジトリの選択**」 ペインで 「**PartsUnlimited**」 をクリックします。
1.  「**パイプラインの構成**」 ペインで 「**ASP<nolink>.NET**」 をクリックし、このテンプレートをパイプラインの起点として利用します。これにより、「**パイプライン YAML のレビュー**」 ペインが開きます。

    > **注**: パイプラインの定義は、リポジトリのルートで「**azure-pipelines.yml**」という名前のファイルとして保存されます。このファイルには、典型的な ASP<nolink>.NET ソリューションを構築してテストするために必要なステップが含まれます。また、必要に応じてビルドをカスタマイズすることもできます。このシナリオでは、**プール**を更新し、Visual Studio 2017 を実行している VM を使用できるようにします。

1.  `trigger` が **master** であることを確認します。

    > **注**: リポジトリに**マスター**または**メイン** ブランチがあるかリポジトリでレビューします。組織は新しいリポジトリの既定のブランチ名を選択できます。[既定のブランチを変更](https://docs.microsoft.com/ja-jp/azure/devops/repos/git/change-default-branch?view=azure-devops#choosing-a-name)します。 

1.  「**Review your pipeline YAML**」 ペインの **10** 行目で、`vmImage: 'windows-latest'` を `vmImage: 'vs2017-win2016'` に置き換えます。
1.  「**Review your pipeline YAML**」 ペインで 「**Save and run**」 をクリックします。
1.  「**Save and run**」 ペインで既定の設定を承諾し、「**Save and run**」 をクリックします。
1.  パイプライン実行ペインの 「**Jobs**」 セクションで 「**Job**」 をクリックし、進捗状況を監視して、完了したことを確認します。 

    > **注**: 警告やエラーなど、YAML ファイルの各タスクをレビューできます。

1.  パイプライン実行ペインに戻り、「**Summary**」 タブから 「**Tests**」 タブに切り替えてテスト統計情報をレビューします。

#### タスク 3: YAML 定義に継続的デリバリーを追加する

このタスクでは、以前のタスクで作成したパイプラインの YAML ベースの定義に継続的デリバリーを追加します。

> **注**: ビルドとテストのプロセスに成功すると、YAML 定義にデリバリーを追加できます。 

1.  パイプライン実行ペインで、右上コーナーにある省略記号をクリックし、ドロップダウン メニューで 「**パイプラインの編集**」 をクリックします。
1.  **azure-pipelines.yaml** ファイルのコンテンツが表示されているペインで **8** 行目の `trigger` セクションの後に以下のコンテンツを追加し、YAML パイプラインの 「**ビルド**」 ステージを定義します。 

    > **注**: パイプラインの進捗状況をよりよく整理して追跡するために必要なステージを定義できます。

    ```yaml
    stages:
    - stage: Build
      jobs:
      - job: Build
    ```

1.  YAML ファイルの残りのコンテンツを選択し、**Tab** キーを 2 回押してスペース 4 つ分をインデントします (```job: Build``` と同じインデントに置き換えます)。 

    > **注**: これにより、`pool` セクションで始まるものはすべて `job: Build` の一部になります。 

1.  ファイルの最下部で、以下の項性を追加して 2 番目のステージを定義します。

    ```yaml
    - stage: Deploy
      jobs:
      - job: Deploy
        pool:
          vmImage: 'vs2017-win2016'
        steps:
    ```

1.  YAML 定義の最後で新しいライン上にカーソルを配置します。 

    > **注**: これは、新しいタスクが追加される場所になります。

1.  コード ペインの右側のタスク一覧で、「**Azure App Service Deploy**」 タスクを検索して選択します。
1.  「**Azure App Service Deploy**」 ペインで以下の設定を指定し、「**Add**」 をクリックします。

    - 「**Azure サブスクリプション**」 ドロップダウン リストで、ラボで以前に Azure リソースをデプロイした Azure サブスクリプションを選択し、「**承認**」 をクリックします。指示されたら、Azure リソース デプロイの際に使用したものと同じユーザー アカウントを使用して認証します。
    - 「**App Service の名前**」 ドロップダウン リストで、ラボで以前にデプロイした Web アプリの名前を選択します。 
    - 「**パッケージまたはフォルダー**」 テキストボックスで `$(System.ArtifactsDirectory)/drop/*.zip` と入力します。 

    > **注**: これにより、デプロイ タスクが YAML パイプラインの定義に自動的に追加されます。

1.  エディターで追加された部分を選択して、**Tab** キーを 2 回押し、スペース 4 つ分をインデントします。これにより、**steps** タスクの子としてリストされます。

    > **注**: **packageForLinux** パラメーターは、Windows および Linux で有効です。 

    > **注**: 既定により、2 つのステージは独立して実行されます。このため、最初のステージのビルド出力は、さらに変更を加えなければ 2 番目のステージで利用できない可能性があります。このような変更を実装するには、ひとつのタスクを使用してビルド出力をビルド ステージの最後に公開し、別のタスクを使ってデプロイ ステージの最初にこれをダウンロードします。 

1.  ビルド ステージの最後に空白のライン上にカーソルを配置して、もうひとつタスクを追加します。(右下の `task: VSTest@2` )
1.  「**タスク**」 ペインで 「**ビルド成果物の公開**」 タスクを検索して選択します。 
1.  「**ビルド成果物の公開**」 ペインで既定の設定を承諾し、「**追加**」 をクリックします。 

    > **注**: これにより、「**drop**」というエイリアスでビルド成果物が公開されます。

1.  追加されたタスクをエディターで選択したままの状態にして、**Tab** キーを 2 回押し、スペース 4 つ分をインデントします (またはタスクが 1 つ上にインデントされるまで **Tab** を押します)。

    > **注**: また、前後に空白のラインを追加して読みやすくすることをお勧めします。

1.  **デプロイ** ステージの **steps** ノードで最初のラインにカーソルを配置します。
1.  「**タスク**」 ペインで 「**ビルド成果物のダウンロード**」 タスクを検索して選択します。
1.  「**追加**」 をクリックします。
1.  エディターで追加されたタスクを選択したままの状態にして、**Tab** キーを 2 回押し、スペース 4 つ分をインデントします。 

    > **注**: ここでも、前後に空白のラインを追加して読みやすくすることをお勧めします。

1.  ダウンロード タスクにプロパティを追加し、`drop` の `artifactName` を指定します (必ずスペースを一致させてください):

    ```
    artifactName: 'drop'
    ```

1.  「**Save**」 をクリックし、「**Save**」 ペインで再び 「**Save**」 をクリックして変更を直接、マスター ブランチにコミットします。

    > **注**: これにより、新しいビルドが自動的にトリガーされます。

1.  パイプラインはこの例のようになります (**自分のサブスクリプションと前回のタスクの webapp を参照します**):

    ```
    trigger:
    - master

    stages:
    - stage: Build
      jobs:
      - job: Build
        pool:
            vmImage: 'vs2017-win2016'

        variables:
            solution: '**/*.sln'
            buildPlatform: 'Any CPU'
            buildConfiguration: 'Release'

        steps:
        - task: NuGetToolInstaller@1

        - task: NuGetCommand@2
          inputs:
            restoreSolution: '$(solution)'

        - task: VSBuild@1
          inputs:
            solution: '$(solution)'
            msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactStagingDirectory)"'
            platform: '$(buildPlatform)'
            configuration: '$(buildConfiguration)'

        - task: VSTest@2
          inputs:
            platform: '$(buildPlatform)'
            configuration: '$(buildConfiguration)'

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            ArtifactName: 'drop'
            publishLocation: 'Container'

    - stage: Deploy
      jobs:
      - job: Deploy
        pool:
            vmImage: 'vs2017-win2016'
        steps:
        - task: DownloadBuildArtifacts@0
          inputs:
            buildType: 'current'
            downloadType: 'single'
            downloadPath: '$(System.ArtifactsDirectory)'
            artifactName: 'drop'
        - task: AzureRmWebAppDeployment@4
          inputs:
            ConnectionType: 'AzureRM'
            azureSubscription: 'YOUR-AZURE-SUBSCRIPTION'
            appType: 'webApp'
            WebAppName: 'YOUR-WEBAPP-NAME'
            packageForLinux: '$(System.ArtifactsDirectory)/drop/*.zip'
    ```

1.  Azure DevOps ポータルが表示されている Web ブラウザー ウィンドウの垂直ナビゲーション ペインで、「**パイプライン**」 を選択します。
1.  「**パイプライン**」 ペインで、新しく構成されたパイプラインを示すエントリをクリックします。
1. 最も直近の実行をクリックします (自動的に開始されています)。
1.  「**概要**」 ペインで、パイプライン実行の進捗状況を監視します。
1.  「*このパイプラインは、この実行のデプロイを継続する前にリソースのアクセス許可が必要です*」というメッセージが表示されたら、「**表示**」 をクリックします。「**レビューの待機中**」 ダイアログ ボックスで 「**許可**」 をクリックします。「**アクセス許可?**」 ペインで再び 「**許可**」 をクリックします。
1.  「**概要**」 ペインの最下部で 「**デプロイ**」 ステージをクリックすると、デプロイの詳細が表示されます。

    > **注**: タスクが完了すると、アプリが Azure Web アプリにデプロイされます。

#### タスク 4: デプロイされたサイトをレビューする

1.  Azure portal を表示している Web ブラウザー ウィンドウに戻り、Azure Web アプリのプロパティが表示されているブレードに移動します。
1.  Azure Web アプリ ブレードの 「**設定**」 セクションで 「**構成**」 を選択します。
1.  Azure Web アプリ構成ブレードの 「**接続文字列**」 セクションで 「**defaultConnection**」 エントリをクリックします。
1.  「**接続文字列の追加/編集**」 ブレードの 「**名前**」 テキストボックスで、現在の値を **DefaultConnectionString** (アプリケーションで期待されているキー) に変更し、「**OK**」 をクリックします。

    > **注**: これにより、アプリ サービス向けに作成されたデータベースにアプリケーションが接続できるようになります。 

1.  再び Azure Web アプリ構成ブレードで 「**保存**」 をクリックし、変更を適用します。指示されたら 「**続行**」 をクリックします。
1.  Azure Web アプリ ブレードで 「**概要**」 をクリックします。概要ブレードで 「**参照**」 をクリックし、新しい Web ブラウザー タブでサイトを開きます。
1.  デプロイされたサイトが新しいブラウザー タブで期待されているように読み込まれていることを確認します。

### 演習 2: Azure ラボ リソースを削除する

この演習では、このラボでプロビジョニングした Azure リソースを削除し、予期しない料金を排除します。 

> **注**: 新しく作成した Azure リソースのうち、使用しないリソースは必ず削除してください。使用しないリソースを削除しないと、予期しないコストが発生する場合があります。

#### タスク 1: Azure ラボ リソースを削除する

このタスクでは、Azure Cloud Shell を使用して、このラボでプロビジョニングされた Azure リソースを削除し、不要な料金を排除します。 

1.  Azure portal で、**Cloud Shell** ウィンドウ内で **Bash** シェル セッションを開きます。
1.  次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを表示します。

    ```sh
    az group list --query "[?starts_with(name,'az400m11l01-RG')].name" --output tsv
    ```

1.  次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを削除します。

    ```sh
    az group list --query "[?starts_with(name,'az400m11l01-RG')].[name]" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
    ```

    > **注**: コマンドは非同期に実行されるので (--nowait パラメーターで決定される)、同じ Bash セッション内ですぐに別の Azure CLI コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

## レビュー

このラボでは、Azure DevOps で YAML を使用して CI/CD パイプラインをコードとして構成しました。
